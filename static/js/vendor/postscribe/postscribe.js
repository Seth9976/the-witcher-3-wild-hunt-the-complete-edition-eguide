(function(){var supports=(function(){var supports={};var html,expected;var work=document.createElement('div');html="<P><I></P></I>";work.innerHTML=html;supports.tagSoup=work.innerHTML!==html;work.innerHTML="<P><i><P></P></i></P>";supports.selfClose=work.childNodes.length===2;return supports;})();var startTag=/^<([\-A-Za-z0-9_]+)((?:\s+[\w-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/;var endTag=/^<\/([\-A-Za-z0-9_]+)[^>]*>/;var attr=/([\-A-Za-z0-9_]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g;var fillAttr=/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noresize|noshade|nowrap|readonly|selected)$/i;var DEBUG=false;function htmlParser(stream,options){stream=stream||'';options=options||{};for(var key in supports){if(supports.hasOwnProperty(key)){if(options.autoFix){options['fix_'+key]=true;}
options.fix=options.fix||options['fix_'+key];}}
var stack=[];var append=function(str){stream+=str;};var prepend=function(str){stream=str+ stream;};var detect={comment:/^<!--/,endTag:/^<\//,atomicTag:/^<\s*(script|style|noscript)[\s>]/i,startTag:/^</,chars:/^[^<]/};var reader={comment:function(){var index=stream.indexOf("-->");if(index>=0){return{content:stream.substr(4,index),length:index+ 3};}},endTag:function(){var match=stream.match(endTag);if(match){return{tagName:match[1],length:match[0].length};}},atomicTag:function(){var start=reader.startTag();if(start){var rest=stream.slice(start.length);var match=rest.match(new RegExp("([\\s\\S]*?)<\/"+ start.tagName+"[^>]*>","i"));if(match){return{tagName:start.tagName,attrs:start.attrs,escapedAttrs:start.escapedAttrs,content:match[1],length:match[0].length+ start.length}}}},startTag:function(){var match=stream.match(startTag);if(match){var attrs={};var escapedAttrs={};match[2].replace(attr,function(match,name){var value=arguments[2]||arguments[3]||arguments[4]||fillAttr.test(name)&&name||null;attrs[name]=value;escapedAttrs[name]=value&&value.replace(/(^|[^\\])"/g,'$1\\\"');});return{tagName:match[1],attrs:attrs,escapedAttrs:escapedAttrs,unary:match[3],length:match[0].length}}},chars:function(){var index=stream.indexOf("<");return{length:index>=0?index:stream.length};}};var readToken=function(){for(var type in detect){if(detect[type].test(stream)){DEBUG&&console.log('suspected '+ type);var token=reader[type]();if(token){DEBUG&&console.log('parsed '+ type,token);token.type=token.type||type;token.text=stream.substr(0,token.length);stream=stream.slice(token.length);return token;}
return null;}}};var readTokens=function(handlers){var tok;while(tok=readToken()){if(handlers[tok.type]&&handlers[tok.type](tok)===false){return;}}};var clear=function(){var rest=stream;stream='';return rest;};var rest=function(){return stream;};if(options.fix){(function(){var EMPTY=/^(AREA|BASE|BASEFONT|BR|COL|FRAME|HR|IMG|INPUT|ISINDEX|LINK|META|PARAM|EMBED)$/i;var BLOCK=/^(ADDRESS|APPLET|BLOCKQUOTE|BUTTON|CENTER|DD|DEL|DIR|DIV|DL|DT|FIELDSET|FORM|FRAMESET|HR|IFRAME|INS|ISINDEX|LI|MAP|MENU|NOFRAMES|NOSCRIPT|OBJECT|OL|P|PRE|SCRIPT|TABLE|TBODY|TD|TFOOT|TH|THEAD|TR|UL)$/i;var INLINE=/^(A|ABBR|ACRONYM|APPLET|B|BASEFONT|BDO|BIG|BR|BUTTON|CITE|CODE|DEL|DFN|EM|FONT|I|IFRAME|IMG|INPUT|INS|KBD|LABEL|MAP|OBJECT|Q|S|SAMP|SCRIPT|SELECT|SMALL|SPAN|STRIKE|STRONG|SUB|SUP|TEXTAREA|TT|U|VAR)$/i;var CLOSESELF=/^(COLGROUP|DD|DT|LI|OPTIONS|P|TD|TFOOT|TH|THEAD|TR)$/i;var stack=[];stack.last=function(){return this[this.length- 1];};stack.lastTagNameEq=function(tagName){var last=this.last();return last&&last.tagName&&last.tagName.toUpperCase()===tagName.toUpperCase();};stack.containsTagName=function(tagName){for(var i=0,tok;tok=this[i];i++){if(tok.tagName===tagName){return true;}}
return false;};var correct=function(tok){if(tok&&tok.type==='startTag'){tok.unary=EMPTY.test(tok.tagName)||tok.unary;}
return tok;};var readTokenImpl=readToken;var peekToken=function(){var tmp=stream;var tok=correct(readTokenImpl());stream=tmp;return tok;};var closeLast=function(){var tok=stack.pop();prepend('</'+tok.tagName+'>');};var handlers={startTag:function(tok){var tagName=tok.tagName;if(tagName.toUpperCase()==='TR'&&stack.lastTagNameEq('TABLE')){prepend('<TBODY>');prepareNextToken();}else if(options.fix_selfClose&&CLOSESELF.test(tagName)&&stack.containsTagName(tagName)){if(stack.lastTagNameEq(tagName)){closeLast();}else{prepend('</'+tok.tagName+'>');prepareNextToken();}}else if(!tok.unary){stack.push(tok);}},endTag:function(tok){var last=stack.last();if(last){if(options.fix_tagSoup&&!stack.lastTagNameEq(tok.tagName)){closeLast();}else{stack.pop();}}else if(options.fix_tagSoup){skipToken();}}};var skipToken=function(){readTokenImpl();prepareNextToken();};var prepareNextToken=function(){var tok=peekToken();if(tok&&handlers[tok.type]){handlers[tok.type](tok);}};readToken=function(){prepareNextToken();return correct(readTokenImpl());};})();}
return{append:append,readToken:readToken,readTokens:readTokens,clear:clear,rest:rest,stack:stack};};htmlParser.supports=supports;htmlParser.tokenToString=function(tok){var handler={comment:function(tok){return'<--'+ tok.content+'-->';},endTag:function(tok){return'</'+tok.tagName+'>';},atomicTag:function(tok){console.log(tok);return handler.startTag(tok)+
tok.content+
handler.endTag(tok);},startTag:function(tok){var str='<'+tok.tagName;for(var key in tok.attrs){var val=tok.attrs[key];str+=' '+key+'="'+(val?val.replace(/(^|[^\\])"/g,'$1\\\"'):'')+'"';}
return str+(tok.unary?'/>':'>');},chars:function(tok){return tok.text;}};return handler[tok.type](tok);};for(var key in supports){htmlParser.browserHasFlaw=htmlParser.browserHasFlaw||(!supports[key])&&key;}
this.htmlParser=htmlParser;})();(function(){var globals=this;if(globals.postscribe){return;}
var DEBUG=true;var DEBUG_CHUNK=false;var slice=Array.prototype.slice;function doNothing(){}
function isFunction(x){return"function"==typeof x;}
function each(arr,fn,_this){var i,len=(arr&&arr.length)||0;for(i=0;i<len;i++){fn.call(_this,arr[i],i);}}
function eachKey(obj,fn,_this){var key;for(key in obj){if(obj.hasOwnProperty(key)){fn.call(_this,key,obj[key]);}}}
function set(obj,props){eachKey(props,function(key,value){obj[key]=value;});return obj;}
function defaults(options,_defaults){options=options||{};eachKey(_defaults,function(key,val){if(options[key]==null){options[key]=val;}});return options;}
function toArray(obj){try{return slice.call(obj);}catch(e){var ret=[];each(obj,function(val){ret.push(val);});return ret;}}
function isScript(tok){return(/^script$/i).test(tok.tagName);}
var WriteStream=(function(){var BASEATTR='data-ps-';function data(el,name,value){var attr=BASEATTR+ name;if(arguments.length===2){var val=el.getAttribute(attr);return val==null?val:String(val);}else if(value!=null&&value!==''){el.setAttribute(attr,value);}else{el.removeAttribute(attr);}}
function WriteStream(root){this.actuals=[root];this.proxyHistory='';this.proxyRoot=root.ownerDocument.createElement(root.nodeName);data(this.proxyRoot,'proxyof',0);}
WriteStream.prototype.buildChunk=function(tokens){var nextId=this.actuals.length,raw=[],actual=[],proxy=[];each(tokens,function(tok){raw.push(tok.text);if(tok.attrs){if(!(/^noscript$/i).test(tok.tagName)){var id=nextId++;actual.push(tok.text.replace(/(\/?>)/,' '+BASEATTR+'id='+id+' $1'));proxy.push(tok.type==='atomicTag'?'':'<'+tok.tagName+' '+BASEATTR+'proxyof='+id+(tok.unary?'/>':'>'));}}else{actual.push(tok.text);proxy.push(tok.type==='endTag'?tok.text:'');}});return{tokens:tokens,raw:raw.join(''),actual:actual.join(''),proxy:proxy.join('')};};WriteStream.prototype.write=function(tokens){var chunk=this.buildChunk(tokens);if(!chunk.actual){return;}
chunk.html=this.proxyHistory+ chunk.actual;this.proxyHistory+=chunk.proxy;this.proxyRoot.innerHTML=chunk.html;if(DEBUG_CHUNK){chunk.proxyInnerHTML=this.proxyRoot.innerHTML;}
this.walkNodes();if(DEBUG_CHUNK){chunk.actualInnerHTML=this.actuals[0].innerHTML;}
return chunk;};WriteStream.prototype.walkNodes=function(){var node,stack=[this.proxyRoot];while((node=stack.shift())!=null){var isElement=node.nodeType===1;var isProxy=isElement&&data(node,'proxyof');if(!isProxy){if(isElement){this.actuals[data(node,'id')]=node;data(node,'id',null);}
var parentIsProxyOf=node.parentNode&&data(node.parentNode,'proxyof');if(parentIsProxyOf){this.actuals[parentIsProxyOf].appendChild(node);}}
stack.unshift.apply(stack,toArray(node.childNodes));}};return WriteStream;}());var Worker=(function(){function Worker(el,options){var doc=el.ownerDocument;set(this,{root:el,options:defaults(options,{error:doNothing}),stream:new WriteStream(el),parser:globals.htmlParser('',{autoFix:true}),doc:doc,win:doc.defaultView||doc.parentWindow});}
Worker.prototype.exec=function(task,done){task.run.call(this.win,this.doc);delete task.run;done();};var EVAL=globals.execScript?'execScript':'eval';Worker.prototype.script_inline=function(task,done){try{this.win[EVAL](task.expr);}catch(e){this.options.error(e);}
done();};Worker.prototype.script_remote=function(task,done){var _this=this;var s=this.doc.createElement('script');var props={src:task.src,async:true,onload:function(){s=s.onload=s.onreadystatechange=s.onerror=null;done();},onreadystatechange:function(){if(/^(loaded|complete)$/.test(s.readyState)){s.onload();}},onerror:function(){_this.options.error({message:'remote script failed '+ task.src});s.onload();}};eachKey(task.tok.attrs,function(name,value){if(!props.hasOwnProperty(name)){s.setAttribute(name,value);}});set(s,props);this.root.appendChild(s);};Worker.prototype.write=function(task,done,flow){this.parser.append(task.html);var tok,tokens=[];while((tok=this.parser.readToken())!=null&&!isScript(tok)){tokens.push(tok);}
var chunk=this.stream.write(tokens);if(DEBUG_CHUNK){task.chunk=chunk;}
if(tok){this.onScriptToken(tok,flow);}
done();};Worker.prototype.onScriptToken=function(tok,flow){var remainder=this.parser.clear();var src=tok.attrs.src||tok.attrs.SRC;flow.subtask(src?{type:'script_remote',src:src,tok:tok}:{type:'script_inline',inlinable:true,tok:tok,expr:(tok.content).replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,"$1").replace(/<!--([\s\S]*?)-->/g,"$1")});if(remainder){flow.subtask({type:'write',html:remainder,inlinable:true});}};return Worker;}());var Flow=(function(){function Flow(worker,options){var deferred=[];set(this,{worker:worker,options:defaults(options,{taskAdd:doNothing,taskStart:doNothing,taskDone:doNothing}),active:null,deferred:deferred,_deferred:deferred});}
Flow.prototype.task=function(task,done){this.options.taskAdd(task);this.deferred.push(task);if(done){this.deferred.push(done);}
this.nextIfIdle();return this;};Flow.prototype.subtask=function(child){this.options.taskAdd(child);if(child.inlinable&&!this._deferred.length){this.startTask(child);}else{this._deferred.push(child);}};Flow.prototype.startTask=function(task){var _this=this;if(this.stopRequested){return this._deferred.unshift(task);}
if(isFunction(task)){task.call(this);return this.nextIfIdle();}
var stash={active:this.active,_deferred:this._deferred};set(this,{active:task,_deferred:[]});this.options.taskStart(task);this.worker[task.type](task,function(){_this.doneTask(stash);},this);};Flow.prototype.doneTask=function(stash){this.options.taskDone(this.active);[].unshift.apply(stash._deferred,this._deferred);set(this,stash);if(this.onStop&&!this.active){this.onStop();delete this.onStop;}
this.nextIfIdle();};Flow.prototype.nextIfIdle=function(){var task=!this.active&&this.deferred.shift();if(task){this.startTask(task);}};Flow.prototype.stop=function(onStop){onStop=onStop||doNothing;this.stopRequested=true;if(!this.active){onStop();}else{this.onStop=onStop;}};Flow.prototype.start=function(){this.stopRequested=false;delete this.onStop;this.nextIfIdle();return this;};return Flow;}());var Tracer=(function(){function Tracer(){set(this,{tasks:[],roots:[],active:null});}
Tracer.prototype.taskAdd=function(task){task.id=this.tasks.length;this.tasks.push(task);task.state='waiting';if(this.active){task.cause=this.active.id;(this.active.effects=this.active.effects||[]).push(task.id);}
return task;};Tracer.prototype.taskStart=function(task){var parent=this.active;if(parent){task.parent=parent.id;(parent.childIds=parent.childIds||[]).push(task.id);(parent.children=parent.children||[]).push(task);}else{this.roots.push(task);}
task.state='started';this.active=task;};Tracer.prototype.taskDone=function(task){task.state='done';this.active=task.parent!=null?this.tasks[task.parent]:null;};return Tracer;}());var postscribe=(function(){function start(el,rootTask,options,done){options=defaults(options,{afterWrite:doNothing,done:doNothing});var worker=new Worker(el,options);var flow=new Flow(worker,DEBUG&&new Tracer());flow.name=options.name;postscribe.writers[flow.name]=flow;var doc=el.ownerDocument;var stash={write:doc.write,writeln:doc.writeln};function write(str){flow.subtask({type:'write',html:str,inlinable:true});options.afterWrite(str);}
set(doc,{write:write,writeln:function(str){write(str+'\n');}});flow.task(rootTask,function(){set(doc,stash);options.done();done();});return flow;}
var queue=new Flow({rootTask:function(args,done){args.push(done);args.flow=start.apply(null,args);}});function postscribe(el,html,options){el=(/^#/).test(el)?globals.document.getElementById(el.substr(1)):el.jquery?el[0]:el;options=options||{};var rootTask=isFunction(html)?{type:'exec',run:html}:{type:'write',html:html};var args=set([el,rootTask,options],{type:'rootTask'});queue.task(args);return(el.postscribe={stop:function(){if(args.flow){args.flow.stop();}else{args[1]={type:"exec",run:doNothing};}}});}
return set(postscribe,{writers:{},queue:queue,Worker:Worker,Flow:Flow,Tracer:Tracer,WriteStream:WriteStream,json:function(){var ret={};eachKey(this.writers,function(name,writer){ret[name]=writer.options.roots;});return ret;}});}());globals.postscribe=postscribe;}());